<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Ontario Trails ‚Äî GPS Web Map</title>

  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta name="format-detection" content="telephone=no">

  <!-- PWA -->
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#1472ff">
  <link rel="icon" sizes="192x192" href="icons/icon-192.png">
  <link rel="icon" sizes="512x512" href="icons/icon-512.png">
  <link rel="apple-touch-icon" href="icons/icon-180.png">

  <!-- Vendor CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder@2.4.0/dist/Control.Geocoder.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-search@4.0.0/dist/leaflet-search.min.css" />

  <!-- App CSS -->
  <link rel="stylesheet" href="./app.css" />
</head>
<body>
  <!-- Map -->
  <div id="map"></div>

  <!-- Crosshair in center -->
  <div id="crosshair" aria-hidden="true"></div>

  <!-- Toggle button -->
  <button id="controlToggle" class="control-toggle" aria-expanded="true" title="Open panel">‚ò∞ Controls</button>

  <!-- Controls panel -->
  <aside id="controlPanel" class="control-panel open" aria-hidden="false">
    <div class="panel-header">
      <h2>Map Controls</h2>
      <button id="closePanelBtn" class="icon-btn" title="Close">‚úï</button>
    </div>

    <!-- Tabs -->
<div class="tabs">
  <button class="tab-btn active" data-tab="tab-map">
    <span class="ico" aria-hidden="true">
      <!-- map icon -->
      <svg viewBox="0 0 24 24" fill="none"><path d="M9 5l6 2 6-2v14l-6 2-6-2-6 2V7l6-2z" stroke="currentColor" stroke-width="1.6"/></svg>
    </span>
    Layers
  </button>

  <button class="tab-btn" data-tab="tab-pins">
    <span class="ico" aria-hidden="true">
      <!-- pin icon -->
      <svg viewBox="0 0 24 24" fill="none"><path d="M12 21s6-6 6-10a6 6 0 10-12 0c0 4 6 10 6 10z" stroke="currentColor" stroke-width="1.6"/></svg>
    </span>
    Pins
  </button>

    <button class="tab-btn" data-tab="tab-track">
    <span class="ico" aria-hidden="true">
      <svg viewBox="0 0 24 24" fill="none"><circle cx="11" cy="11" r="7" stroke="currentColor" stroke-width="1.6"/></svg>
    </span>
    Track
  </button>


  <button class="tab-btn" data-tab="tab-search">
    <span class="ico" aria-hidden="true">
      <!-- search icon -->
      <svg viewBox="0 0 24 24" fill="none"><circle cx="11" cy="11" r="7" stroke="currentColor" stroke-width="1.6"/><path d="M20 20l-3.6-3.6" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/></svg>
    </span>
    
  </button>
</div>


    <!-- ===== Tab: Layers ===== -->
    <section id="tab-map" class="tab-panel active" aria-label="Layers">
      <section class="panel-section">
        <h3>Filters</h3>
        <div class="filters" id="filters">
          <label><input type="checkbox" id="showBase" checked> Base map</label>
          <label><input type="checkbox" id="showImagery"> Satellite Imagery (WMTS)</label>

          <!-- Imagery blend slider -->
          <div id="imageryBlendRow" style="display:flex;align-items:center;gap:.5rem;margin:.25rem 0 0 1.5rem;">
            <label for="imageryOpacity" style="font-size:0.9rem;opacity:.85;min-width:3.5rem;">Blend</label>
            <input type="range" id="imageryOpacity" min="0" max="100" value="50" step="1" style="flex:1;">
            <span id="imageryOpacityVal" style="font-variant-numeric:tabular-nums;">100%</span>
          </div>

          <label><input type="checkbox" id="showCLUPA"> Crown Land (CLUPA)</label>
          <label><input type="checkbox" id="showContours"> Elevation Contours</label>
          <label><input type="checkbox" id="showPins" checked> Pins</label>
          <label><input type="checkbox" id="showCrosshair" checked> Crosshair</label>
          <label><input type="checkbox" id="showStocked"> Stocked Lakes</label>
          <label><input type="checkbox" id="showAccess"> Water Access Points</label>
          <label><input type="checkbox" id="showTrails"> Trails (OTN)</label>
        </div>
      </section>

      <section class="panel-section">
        <h3>Legend</h3>

        <div class="legend-items">
          <div><span class="legend-line legend-base"></span>Base</div>
          <div><span class="legend-line legend-trail"></span>Trails (OTN)</div>
          <div><span class="legend-dot"></span>Your location</div>
        </div>

        <!-- Contour color legend -->
        <div class="contour-legend">
          <div class="contour-legend-title">Elevation (m)</div>
          <div class="contour-ramp" aria-hidden="true"></div>
          <div class="contour-ticks">
            <span id="elevMinTick">0</span>
            <span id="elevMidTick">350</span>
            <span id="elevMaxTick">700</span>
          </div>
          <div class="contour-note" id="contourHint">Zoom to <b>11+</b> to load contours</div>
          <div class="contour-note">Version 1.0.7</div>
        </div>
      </section>
    </section>

    <!-- ===== Tab: Pins ===== -->
    <section id="tab-pins" class="tab-panel" aria-label="Pins">
      <section class="panel-section">
        <h3>Pin Drops</h3>
        <div class="row">
          <select id="pinType">
            <option>Camping</option><option>Water</option><option>Viewpoint</option>
            <option>Hazard</option><option>Parking</option><option>Other</option>
          </select>
          <input id="pinLabel" type="text" placeholder="Label (e.g., Camp A)" />
        </div>
        <div class="row">
          <button class="btn" id="addPinBtn">‚ûï Add pin here</button>
          <button class="btn" id="exportPinsBtn">‚¨áÔ∏è Download pins (GPX)</button>
        </div>
        <div class="row">
          <label class="btn" for="importPinsInput">‚¨ÜÔ∏è Upload pins (JSON/GPX)</label>
          <input id="importPinsInput" type="file" accept=".json,.geojson,.gpx" />
          <span id="pinCount" class="muted"></span>
        </div>
      </section>
      </section>

    <!-- ===== Tab: Track Recorder ===== -->
     <section id="tab-track" class="tab-panel" aria-label="Track">
      <section class="panel-section">
        <h3>Track Recorder</h3>
        <div class="row">
          <button class="btn" id="trackStartBtn">‚óè Start</button>
          
          <button class="btn" id="trackSaveBtn" disabled>üíæ Save GPX</button>
        </div>
      </section>

      <section class="panel-section">
        <h3>Map Actions</h3>
        <div class="row">
          <button class="btn" id="locateBtn">üìç Locate</button>
          <button class="btn" id="followBtn">‚ñ∂Ô∏è Follow: Off</button>
          <button class="btn" id="resetViewBtn">‚Ü∫ Reset view</button>
        </div>
      </section>

    </section>

    <!-- ===== Tab: Search ===== -->
    <section id="tab-search" class="tab-panel" aria-label="Search">
      <section class="panel-section">
        <h3>Search (Ontario / Quebec)</h3>
        <div class="search-row">
          <input id="searchInput" type="text" placeholder="Address, lake, park‚Ä¶" autocomplete="off">
          <button class="btn" id="searchBtn">Search</button>
        </div>
        <div id="searchResults" class="search-results" role="listbox" aria-label="Results"></div>
      </section>
    </section>
  </aside>

  <!-- Vendor JS -->
  <script defer src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script defer src="https://unpkg.com/leaflet-control-geocoder@2.4.0/dist/Control.Geocoder.js"></script>
  <script defer src="https://unpkg.com/leaflet-search@4.0.0/dist/leaflet-search.min.js"></script>
  <script defer src="https://unpkg.com/esri-leaflet@3.0.12/dist/esri-leaflet.js"></script>

  <!-- App JS -->
  <script defer src="./app.js"></script>

  <script>
  // PWA Service Worker registration and auto-update activation
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', async () => {
      try {
        const reg = await navigator.serviceWorker.register('./service-worker.js');
        console.info('Service Worker registered:', reg.scope);

        // Listen for updates
        reg.addEventListener('updatefound', () => {
          const newSW = reg.installing;
          if (!newSW) return;

          newSW.addEventListener('statechange', () => {
            if (newSW.state === 'installed') {
              if (navigator.serviceWorker.controller) {
                console.info('New version available ‚Äî activating...');
                newSW.postMessage('SKIP_WAITING');
                // Optional: prompt user or reload immediately
                setTimeout(() => window.location.reload(), 800);
              } else {
                console.info('Service Worker installed for the first time.');
              }
            }
          });
        });
      } catch (err) {
        console.warn('Service Worker registration failed:', err);
      }
    });
  }
</script>


</body>
</html>
